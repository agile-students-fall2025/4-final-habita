name: Continuous Deployment

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install backend dependencies
        working-directory: ./back-end
        run: npm ci

      - name: Run backend tests
        working-directory: ./back-end
        run: npm test

      - name: Deploy to Digital Ocean
        if: vars.DEPLOY_PLATFORM == 'digitalocean'
        uses: digitalocean/app_action@v1.1.5
        with:
          app_name: ${{ secrets.DO_APP_NAME }}
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Deploy to Heroku
        if: vars.DEPLOY_PLATFORM == 'heroku'
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_BACKEND_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: back-end

      - name: Deploy to Railway
        if: vars.DEPLOY_PLATFORM == 'railway'
        run: |
          npm install -g @railway/cli
          railway up --service backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: ./back-end

      - name: Deploy to Render
        if: vars.DEPLOY_PLATFORM == 'render'
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"serviceId": "${{ secrets.RENDER_BACKEND_SERVICE_ID }}"}' \
            https://api.render.com/v1/services/${{ secrets.RENDER_BACKEND_SERVICE_ID }}/deploys

      - name: Deployment notification
        if: success()
        run: |
          echo "Backend deployed successfully to ${{ vars.DEPLOY_PLATFORM }}"
          echo "Deployment completed at $(date)"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install frontend dependencies
        working-directory: ./front-end
        run: npm ci

      - name: Run frontend tests
        working-directory: ./front-end
        run: npm test -- --coverage --watchAll=false

      - name: Build frontend
        working-directory: ./front-end
        run: npm run build
        env:
          CI: false
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}

      - name: Deploy to Vercel
        if: vars.DEPLOY_PLATFORM == 'vercel'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./front-end
          vercel-args: '--prod'

      - name: Deploy to Netlify
        if: vars.DEPLOY_PLATFORM == 'netlify'
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './front-end/build'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Deploy to GitHub Pages
        if: vars.DEPLOY_PLATFORM == 'github-pages'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./front-end/build

      - name: Deploy to Digital Ocean Spaces (Static)
        if: vars.DEPLOY_PLATFORM == 'do-spaces'
        uses: BetaHuhn/do-spaces-action@v2
        with:
          access_key: ${{ secrets.DO_SPACES_ACCESS_KEY }}
          secret_key: ${{ secrets.DO_SPACES_SECRET_KEY }}
          space_name: ${{ secrets.DO_SPACE_NAME }}
          space_region: ${{ secrets.DO_SPACE_REGION }}
          source: "front-end/build"

      - name: Deployment notification
        if: success()
        run: |
          echo "Frontend deployed successfully to ${{ vars.DEPLOY_PLATFORM }}"
          echo "Deployment completed at $(date)"

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()

    steps:
      - name: Generate deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Platform" >> $GITHUB_STEP_SUMMARY
          echo "- Target: ${{ vars.DEPLOY_PLATFORM }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Timestamp" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed at: $(date)" >> $GITHUB_STEP_SUMMARY
